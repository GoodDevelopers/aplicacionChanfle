{% extends 'base.html.twig' %}

{% block stylesheets %}
    {{parent()}}

    <link rel="stylesheet" href="{{ asset('bundles/ventas/css/EstiloVentas.css') }}" />
{% endblock %}

{% block body %}
    <div id="div_title" class="panel-primary"><h1>Nueva Venta</h1></div>

 

    {{ form_start(form)}}

    {{form_label(form.cliente)}}
    {{form_widget(form.cliente , {'attr':{'class': 'form-group', 'placeholder':'Identificacion Cliente'}})}}
    <input  type="button" id="boton_buscar_cliente" value="Buscar" onclick="buscarCliente();" class="btn-success"/>
    <label>Cliente:</label>  <input type="text" id="Nombre_cliente" placeholder="Nombre Cliente" disabled="true"/>
    <label>Puntos Acumulados:</label><input type="text" id="Puntos_cliente" placeholder="Puntos Acumulados" disabled="true"/>


    <div class="form-control"> 

        {{form_label(form.mesa)}}
        {{form_widget(form.mesa,{'attr':{'class': 'form-group', 'placeholder':'Mesa'}})}}
        {{form_label(form.personasPorMesa)}}
        {{form_widget(form.personasPorMesa,{'attr':{'class': 'form-group', 'Placeholder':'Personas Por Mesa'}})}}

        {{form_label(form.tipoVenta)}}
        {{form_widget(form.tipoVenta,{'attr':{'class':'form-group', 'placeholder':'Tipo de Venta'}})}}

    </div>

{{ form_widget(form.detalles)}}
    <div class="form-control">
        <label>Nombre Producto:</label><input type="text" placeholder="Nombre Producto" id="NombreProducto"/>
        <button type="button" onclick="buscarProducto();">Buscar Producto</button>
        <label>Precio:</label> <input type="number" placeholder="Precio" id="PrecioProducto" disabled="true"/>
        <label>Cantidad:</label><input type="number" placeholder="Cantidad" id="CantidadProducto"/>
        <button class="btn-success" type="button" onclick="Agregar();">Agregar Producto</button>

    </div>

    <ul id="productos" class="detalles" data-prototype="{{ form_widget(form.detalles.vars.prototype.producto.nombre)|e}}" ></ul>
    <ul id="cantidades" class="detalles" data-prototype="{{ form_widget(form.detalles.vars.prototype.cantidad)|e}}" ></ul>

    <table class="table" id="Tabla_Productos" name="TablaProductos">
        <thead>
            <tr>
                <th>NOMBRE PRODUCTO</th>
                <th>VALOR UNITARIO</th>
                <th>CANTIDAD</th>
                <th>ACCIONES</th>

            </tr>
        </thead>
        <tbody id="CuerpoTabla"></tbody>
    </table>



    <div class="form-control"> 
        {{form_label(form.valorTotal)}}
        {{form_widget(form.valorTotal,{'attr':{'class': 'form-group', 'value':'0'}})}}
        {{form_label(form.puntosVenta)}}
        {{form_widget(form.puntosVenta,{'attr':{'class': 'form-group', 'value':'0'}})}}
    </div>


    <div class="form-control"><button  class="btn-success" type="submit"> Aceptar </button>
        <button class="btn-info"> <a class="EnlaceBoton" href="{{ path('venta_index') }}">Regresar</a></button></div>  


    {{form_end(form)}}


{% endblock %}
{% block javascripts %}    
    {{ parent() }}

    <script type="text/javascript">

        var Productos = [];
        var Cantidades = [];
        var Precio = [];
        var total = 0;
        var NumeroP = $('#productos').length;
        var NumeroC = $('#cantidades').length;
        var numeroProducto = 1;


        function buscarCliente() {

            var id = $('#venta_cliente').val();

            $.ajax({
                url: "{{ path('buscar_cliente_venta') }}",
                data: ({id: id}),
                method: 'POST',
                dataType: "json",
                success: function (data) {
                    if (data == null) {
                        alert('datos no encontrados');
                    } else {

                        $('#Nombre_cliente').val(data["nombre"]);
                        $('#Puntos_cliente').val(data["Puntos"]);
                        $('#venta_type2_mesa').focus();


                    }
                }
            });

        }

        function buscarProducto() {

            var nombre = $("#NombreProducto").val();

            $.ajax({
                url: "{{path('buscar_producto')}}",
                data: ({nombre_p: nombre}),
                method: 'POST',
                dataType: "json",
                success: function (data) {
                    if (data == null) {
                        alert('datos no encontrados');
                    } else {
                        $("#PrecioProducto").val(data["precio"]);
                        $("#CantidadProducto").focus();
                    }
                }
            });
        }

        function Agregar() {

            var nombreProducto = $('#NombreProducto').val();
            var cantidad = $('#CantidadProducto').val();
            var precio = $('#PrecioProducto').val(); 
            var ListaProductos = $('#productos');
            var ListaCantidades = $('#cantidades');   
            
            var NumeroSerie = "" + nombreProducto + numeroProducto;
            $('#CuerpoTabla').append(agregarProductoTabla(NumeroSerie,nombreProducto, precio, cantidad));
            total = $('#venta_valorTotal').val();
            total = parseInt(total) + parseInt(precio) * parseInt(cantidad);
            $('#venta_valorTotal').val(total);
            $('#NombreProducto').val("");
            $('#PrecioProducto').val("");
            $('#CantidadProducto').val("");
            $('#NombreProducto').focus();
            ListaProductos.data('prototype', '<input class="hidden" type="text" id="'+ NumeroSerie +'" name="venta[detalles][__name__][producto][nombre]" value="' + nombreProducto + '"/>');
            ListaCantidades.data('prototype', '<input class="hidden" type="text" id="venta_type2_detalles___name___cantidad" name="venta[detalles][__name__][cantidad]" value="' + cantidad + '"/>');
            var prototype = ListaProductos.data('prototype');
            var prototype2 = ListaCantidades.data('prototype');
            var newform = prototype.replace(/__name__/g, NumeroP);
            var newform2 = prototype2.replace(/__name__/g, NumeroC);

            NumeroP++;
            NumeroC++;
            var NewLi = $('<li class="hidden"></li>').append(newform);
            var NewLi2 = $('<li class="hidden"></li>').append(newform2);
            NewLi.appendTo(ListaProductos);
            NewLi2.appendTo(ListaCantidades);
         
            Cantidades[NumeroSerie] = cantidad;
            Precio[NumeroSerie] = precio;
            numeroProducto ++;
        
         
         }

        function agregarProductoTabla(nombreS,nombre, precioUnitario, cantidad) {
            Productos =
                    "<tr id=" + 'producto' + nombreS + ">" +
                    "<td>" + nombre + "</td>" +
                    "<td>" + precioUnitario + "</td>" +
                    "<td>" + cantidad + "</td>" +
                    "<td>" + "<button id=" + nombreS + " type='button' onclick='quitarTablaProducto(this.id);'>ELIMINAR</button>" + "</td>" +
                    "</tr>";
            return Productos;
        }

        function quitarTablaProducto(clicked_id) {
            var id = clicked_id;
            $('#producto' + id).remove();
            $('#productos :input[id=' + id + ']').remove();

            var valorActual = $('#venta_valorTotal').val();
            $("#venta_valorTotal").val(valorActual - Precio[id] * Cantidades[id]);
            $("#CantidadProducto").focus();
        }



    </script>

{% endblock %}
